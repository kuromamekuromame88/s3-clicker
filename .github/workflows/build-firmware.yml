name: Build and Save Firmware

on:
  push:
    branches: [ main ]  # mainブランチにpushされた時のみ実行

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        board: [esp32s3_usb_otg] # 複数ボードに対応可能
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 他ブランチへpushするため履歴を取得

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PlatformIO
        run: pip install platformio

      - name: Build firmware
        run: platformio run -e ${{ matrix.board }}

      - name: Prepare firmware folder
        run: |
          mkdir -p firmware/${{ matrix.board }}
          cp .pio/build/${{ matrix.board }}/firmware.bin firmware/${{ matrix.board }}/
          echo "Build date: $(date)" > firmware/${{ matrix.board }}/info.txt
          echo "Source commit: $GITHUB_SHA" >> firmware/${{ matrix.board }}/info.txt

      - name: Push firmware to firmware-builds branch
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git checkout -B firmware-builds

          # firmwareフォルダ以外を削除
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name 'firmware' -exec rm -rf {} +

          git add firmware
          git commit -m "Add firmware for ${{ matrix.board }} from commit $GITHUB_SHA" || echo "No changes to commit"
          git push origin firmware-builds --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
