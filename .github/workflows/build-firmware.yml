name: ビルドとファームウェアのリリース

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        board: [esp32s3usbotg]  # 複数ボード対応可

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MY_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PlatformIO
        run: pip install platformio

      - name: Build firmware
        run: platformio run -e ${{ matrix.board }}

      - name: Prepare firmware folder
        run: |
          mkdir -p firmware/${{ matrix.board }}
          cp .pio/build/${{ matrix.board }}/firmware.bin firmware/${{ matrix.board }}/
          echo "Build date: $(date)" > firmware/${{ matrix.board }}/info.txt
          echo "Source commit: $GITHUB_SHA" >> firmware/${{ matrix.board }}/info.txt

      # --- firmware-buildsブランチにpush ---
      - name: Push firmware to firmware-builds branch
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git fetch origin
          git checkout -B firmware-builds

          for item in * .*; do
            if [ "$item" != "." ] && [ "$item" != ".." ] && [ "$item" != ".git" ] && [ "$item" != "firmware" ]; then
              rm -rf "$item"
            fi
          done

          git add -A
          git commit -m "Add firmware for ${{ matrix.board }} from commit $GITHUB_SHA" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.MY_PAT }}@github.com/${{ github.repository }} firmware-builds --force

      # --- GitHub Releaseを作成＆アップロード ---
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "Firmware Build ${{ github.run_number }}"
          body: |
            Automated build for board: **${{ matrix.board }}**
            Commit: ${{ github.sha }}
            Build number: ${{ github.run_number }}
          files: |
            firmware/${{ matrix.board }}/firmware.bin
            firmware/${{ matrix.board }}/info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.MY_PAT }}
